/*
Copyright (c) 2024  Blue Robotics

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
/*
 * A Schema to demonstrate common features
 */

/*
 * Define the packet header
 */
define Packet block {
	uint32 key //this should be set when this defined block is used below.
	uint16 length  //the length of the packet in words
	uint16 blocks //this is an index to the block fields section of the packet
	/* a CRC-32 for packet error detection
	 * this is computed on all words of the packet
	 * this is only necessary to check if the transport method
	 * does not have error detection mechanism
	 */
	uint32 crc
}
/* 
 * This is the top level hierarchy of a BR packet
 */
Packet brPacket(key = 0x45554c42) {
	/*
	 * Now the payload header
	 */
	define Payload block {
		uint16 key
		uint8 length //the length of the payload in 4-byte words
		uint8 blocks //this is an index to the block fields section of the packet
	}
	
	/*
	 * This is the header for an array
	 */
	define Array array {
		uint8 key //a unique identifier of this block
		uint8 length //the length of one unit of this block
		uint8 repeats //this indicates the number units of this block
	}

	/* this section conveys the ID of the device
	 * this a unique identifier
	 * any payload following an ID payload is assumed only to be
	 * to or from that particular device.
	 * A device will always send an ID payload with every packet.
	 * A bus controller does not need to send an ID payload.
	 * A packet without one shall still be processed by a peripheral
	 */
	Payload idPayload(key = 0x0001) {
		uint32 id
	}
	/**
	 * a request by the bus controller to all devices that have not communicated successfully recently
	 * the controller can specify the probability and timeframe that the peripherals will respond
	 * the peripherals will respond with an idPayload
	 */
	Payload whosTherePayload {
		float32 probability //the probability that the peripheral will respond. 1.0 is 100% probability, 0.0 is zero.
		float32 time //the time in seconds within which the device should respond.
	}
	
	/*
	 * A payload for a peripheral to convey its details to the controller.
	 * A controller requests a version payload by sending an empty one.
	 */
	Payload versionPayload(key = 0x0002) {
	
		uint32 fw //this is the version of the firmware
	
		// this defines the type of hardware (i.e. type/purpose of PCB)
		define HwDef compound {
			define HwType enum uint16 {
				UNDEFINED   = 0xffff
				SFDQ      	= 0x0000
				BLUE_SERVO	= 0x0001
				LUMEN       = 0x0002
				NUCLEO     	= 0x0003
				BLUE_ESC
			}
			HwType hwType
			define McuType enum uint8 {
				UNDEFINED = 0xff
				STM32F446 = 0x01
				STM32H563 = 0x02
				STM32H573 = 0x03
				STM32G071 = 0x04
			}
			McuType mcuType
			uint8 revision
			//bool testBit1 //this causes it to fail because there's not enough room
			
		
		}
		HwDef hwDef //this allocates a field of the hardware definition compound type
		bool testBit2
		bool testBit3
	}
	/*
     * a payload for conveying ADC values and configuring the adc
     * the controller can send this with configuration parameters
     * the peripheral can send this with adc values and/or config parameters
	 */
	Payload adcPayload(key = 0x0003) {
		Array values {
			float32 value
		}
		Array timeConstants {
			float32 seconds
		}
		Array gains {
			float32 gain
		}
		Array offsets {
			float32 offset
		}
	}
}

