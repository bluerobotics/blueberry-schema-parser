/*
 * A Schema to demonstrate common features
 */

/*
 * Define the packet header
 */
define Packet block {
	uint32 key //this should be set when this defined block is used below
	uint16 length  //the length of the packet in words
	uint16 blocks //this is an index to the block fields section of the packet
	/* a CRC-32 for packet error detection
	 * this is computed on all words of the packet
	 * this is only necessary to check if the transport method
	 * does not have error detection mechanism
	 */
	uint32 crc
}
/*
 * Now the payload header
 */
define Payload block {
	uint16 key
	uint8 length //the length of the payload in 4-byte words
	uint8 blocks //this is an index to the block fields section of the packet
	
}
/*
 * This is the header for an array
 */
define Array block {
	uint8 key //a unique identifier of this block
	uint8 length //the length of one unit of this block
	uint8 repeat //this indicates the number units of this block
	uint8 blocks //this indicates the index to the first block field of this block - the first field of base types
}	
/* 
 * This is the top level hierarchy of a BR packet
 */
Packet brPacket(key = 0x45554c42) {

	/* this section conveys the ID of the device
	 * this a unique identifier
	 * any payload following an ID payload is assumed only to be
	 * to or from that particular device.
	 * A device will always send an ID payload with every packet.
	 * A bus controller does not need to send an ID payload.
	 * A packet without one shall still be processed by a peripheral
	 */
	Payload idPayload(key = 0x0001) {
		uint32 id
	}
	
	/*
	 * A payload for a peripheral to convey its details to the controller.
	 * A controller requests a version payload by sending an empty one.
	 */
	Payload versionPayload(key = 0x0002) {
	
		uint32 fw //this is the version of the firmware
	
		// this defines the type of hardware (i.e. type/purpose of PCB)
		// note that this is an example of a combination define and
		// field declaration. The defined type is "HwDef" and the field 
		// field name is "hwDef"
		define HwDef compound hwDef {
			enum uint16 hwType {
				UNDEFINED_HW_TYPE   = 0xffff
				SFDQ_HW_TYPE        = 0x0000
				BLUE_SERVO_HW_TYPE  = 0x0001
				LUMEN_HW_TYPE       = 0x0002
				NUCLEO_HW_TYPE      = 0x0003
			}
			enum uint8 mcuType {
				UNDEFINED = 0xff
				STM32F446 = 0x01
				STM32H563 = 0x02
				STM32H573 = 0x03
				STM32G071 = 0x04
			}
			uint8 revision
			}
		}
		/*
	     * a payload for conveying ADC values
		 */
		Payload AdcPayload(key = 0x0003) {
			Array values {
				float32 value
			}
		}
	}
}	